# Copyright (c) 2016 Mirants Lu. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file. 

#--------------------------------------------------------------------
# Uncomment exactly one of the lines labelled (1), (2), and (3) below 
# to switch between compilation modes.
#
# (1) Production use (optimized mode)
      OPT ?= -O2 -DNDEBUG
# (2) Debug mode, w/full line-level debugging symbols
#     OPT ?= -g2
# (3) Profiling mode: opt, but w/debugging symbols
#     OPT ?= -O2 -g2 -DNDEBUG
#--------------------------------------------------------------------

# detect what platform we're building on
$(shell CXX="$(CXX)" \
  ./build_detect_platform build_config.mk)

# this  file is generated by the previous line to set build flags and sources
include build_config.mk

CXXFLAGS += $(PLATFORM_CXXFLAGS) $(OPT)
LDFLAGS += $(PLATFORM_LDFLAGS)
LIBS += $(PLATFORM_LIBS)

PROTOC = protoc

PROTOS_PATH = .

vpath %.proto $(PROTOS_PATH)

all: journey_client journey_server

journey_client: journey.pb.o journey_client.o
	$(CXX) $(CXXFLAGS) $^ $(LDFLAGS) $(LIBS) -o $@

journey_server: journey_db.o journey_db_machine.o \
                journey.pb.o journey_service_impl.o journey_server.o
	$(CXX) $(CXXFLAGS) $^ $(LDFLAGS) $(LIBS) -o $@

%.pb.cc: %.proto
	$(PROTOC) -I $(PROTOS_PATH) --cpp_out=. $<

.PHONY: clean
clean:
	-rm -f *.o *.pb.cc *.pb.h journey_client journey_server build_config.mk
